<!-- MQTT.JS (WAJIB ADA, JANGAN DIHAPUS) -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<script>
/* ================= MQTT CONFIG ================= */
const MQTT_URL = "wss://86d0fa0f82ae46da8385c68ee23959f5.s1.eu.hivemq.cloud:8884";
const MQTT_OPTIONS = {
  protocol: "wss",
  path: "/mqtt",
  username: "kandang",
  password: "Firman1502",
  keepalive: 30,
  reconnectPeriod: 2000,
  clean: true
};

const TOPIC = "monitoring/air/level";
const MAX_DEPTH_CM = 200;

/* ================= CONNECT ================= */
const client = mqtt.connect(MQTT_URL, MQTT_OPTIONS);

client.on("connect", () => {
  console.log("MQTT CONNECTED");
  client.subscribe(TOPIC);
  setStatus(true);
});

client.on("message", (topic, message) => {
  const distance = parseFloat(message.toString());
  if (isNaN(distance)) return;

  const waterHeight = Math.max(0, MAX_DEPTH_CM - distance);
  const percent = Math.min(100, Math.round((waterHeight / MAX_DEPTH_CM) * 100));

  document.getElementById("water-cm").innerText = distance;
  document.getElementById("water-percentage").innerText = percent + "%";
  document.getElementById("water-fill").style.height = percent + "%";

  const alert = document.getElementById("alert-status");
  if (percent >= 80) {
    alert.innerText = "CRITICAL";
    alert.className = "text-sm font-bold text-red-500";
  } else if (percent >= 60) {
    alert.innerText = "WARNING";
    alert.className = "text-sm font-bold text-yellow-400";
  } else {
    alert.innerText = "SAFE";
    alert.className = "text-sm font-bold text-emerald-400";
  }
});

client.on("error", (err) => {
  console.error("MQTT ERROR:", err);
  setStatus(false);
});

/* ================= UI STATUS ================= */
function setStatus(online) {
  const indicator = document.getElementById("status-indicator");
  const text = document.getElementById("status-text");

  if (!indicator || !text) return;

  if (online) {
    indicator.className =
      "flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 text-xs font-medium";
    text.innerText = "Live System";
  } else {
    indicator.className =
      "flex items-center gap-2 px-3 py-1 rounded-full bg-red-500/20 text-red-400 border border-red-500/30 text-xs font-medium";
    text.innerText = "Disconnected";
  }
}
</script>
